<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>AI ç›´æ’­è½å¯«æ©Ÿ (é•·å¥é˜²çˆ†ç‰ˆ)</title>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background: #222; color: #fff; text-align: center; padding: 50px; }
        
        /* ç‹€æ…‹åˆ— */
        #ws-status { font-size: 16px; margin-bottom: 20px; color: #ff5555; }
        #status { font-size: 24px; margin-bottom: 20px; color: #aaa; }
        
        /* éº¥å…‹é¢¨é¸å–® */
        .select-container { margin: 20px 0; }
        select { padding: 10px; font-size: 16px; border-radius: 5px; border: none; background: #333; color: white; max-width: 400px; }

        /* çµæœé¡¯ç¤ºå€ (å®¹å™¨) */
        .result-box {
            font-size: 28px; font-weight: bold; margin: 20px auto; min-height: 80px; 
            border: 2px dashed #444; padding: 20px; width: 80%; border-radius: 10px; 
            background: #1a1a1a; text-align: left; line-height: 1.5;
        }

        /* æœ€çµ‚ç¢ºèªçš„æ–‡å­— (ç¶ è‰²) */
        #final_span { color: #0f0; }
        
        /* æ­£åœ¨è¾¨è­˜ä¸­çš„æ–‡å­— (ç°è‰²) */
        #interim_span { color: #888; }

        button { padding: 15px 30px; font-size: 20px; cursor: pointer; border: none; border-radius: 5px; background: #4CAF50; color: white; transition: 0.3s; }
        button:hover { background: #45a049; }
        
        .recording { color: #ff5555 !important; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.5; } }
        .connected { color: #4CAF50 !important; }
    </style>
</head>
<body>
    <h1>ğŸ™ï¸ AI ç›´æ’­è½å¯«æ©Ÿ (é•·å¥é˜²çˆ†ç‰ˆ)</h1>
    
    <div id="ws-status">ğŸ”´ æ­£åœ¨é€£æ¥ Streamer.bot...</div>
    
    <div class="select-container">
        <label for="audioSource">é¸æ“‡éº¥å…‹é¢¨ï¼š</label>
        <select id="audioSource">
            <option value="">è®€å–ä¸­...</option>
        </select>
        <button onclick="getMicrophones()" style="padding: 5px 10px; font-size: 14px; background: #555;">ğŸ”„ é‡æ–°è®€å–</button>
    </div>

    <div id="status">æº–å‚™å°±ç·’</div>
    
    <div class="result-box">
        <span id="final_span">...</span>
        <span id="interim_span"></span>
    </div>
    
    <button onclick="toggleRecognition()" id="btn">é–‹å§‹ç›£è½</button>

    <script>
        // ================= è¨­å®šå€ =================
        const wsUrl = "ws://127.0.0.1:8080/";
        const actionName = "AI_Listener"; 
        // =========================================

        let recognition;
        let isRecording = false;
        let ws;
        const audioSelect = document.querySelector('select#audioSource');
        const finalSpan = document.getElementById('final_span');
        const interimSpan = document.getElementById('interim_span');

        window.onload = async () => {
            initWebSocket();
            await getMicrophones();
        };

        function initWebSocket() {
            ws = new WebSocket(wsUrl);
            ws.onopen = () => { 
                document.getElementById('ws-status').innerText = "ğŸŸ¢ å·²é€£æ¥ Streamer.bot";
                document.getElementById('ws-status').classList.add("connected");
            };
            ws.onerror = () => document.getElementById('ws-status').innerText = "ğŸ”´ ç„¡æ³•é€£æ¥ (è«‹ç¢ºèª WebSocket Server æœ‰é–‹)";
            ws.onclose = () => setTimeout(initWebSocket, 3000);
        }

        async function getMicrophones() {
            let tempStream = null;
            try {
                tempStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                const devices = await navigator.mediaDevices.enumerateDevices();
                const audioDevices = devices.filter(device => device.kind === 'audioinput');
                
                audioSelect.innerHTML = ""; 
                if (audioDevices.length === 0) {
                     audioSelect.innerHTML = "<option>æ‰¾ä¸åˆ°éº¥å…‹é¢¨</option>";
                } else {
                    audioDevices.forEach(device => {
                        const option = document.createElement('option');
                        option.value = device.deviceId;
                        option.text = device.label ? device.label : `éº¥å…‹é¢¨ (${device.deviceId.slice(0, 8)}...)`;
                        audioSelect.appendChild(option);
                    });
                }
            } catch (err) {
                console.error("æ¬Šé™éŒ¯èª¤:", err);
                audioSelect.innerHTML = "<option>âš ï¸ è«‹å…è¨±éº¥å…‹é¢¨æ¬Šé™</option>";
            } finally {
                if (tempStream) tempStream.getTracks().forEach(track => track.stop());
            }
        }

        if ('webkitSpeechRecognition' in window) {
            recognition = new webkitSpeechRecognition();
            recognition.continuous = true;
            
            // â˜…â˜…â˜… é—œéµä¿®æ”¹ï¼šé–‹å•Ÿå³æ™‚é è¦½ â˜…â˜…â˜…
            // é€™æ¨£ä½ å¯ä»¥çœ‹åˆ°æ­£åœ¨è¬›çš„å­— (ç°è‰²)ï¼Œé¿å…è¬›å¤ªä¹…ä¸çŸ¥é“æ–·ç·š
            recognition.interimResults = true; 
            
            recognition.lang = 'zh-TW';

            recognition.onstart = () => {
                isRecording = true;
                document.getElementById('status').innerText = "ğŸ¤ æ­£åœ¨è†è½ä¸­...";
                document.getElementById('status').classList.add("recording");
                document.getElementById('btn').innerText = "åœæ­¢";
                document.getElementById('btn').style.background = "#f44336";
                interimSpan.innerText = ""; // æ¸…ç©ºæš«å­˜
            };

            recognition.onend = () => {
                if (isRecording) {
                    console.log("è‡ªå‹•é‡é€£...");
                    recognition.start();
                } else {
                    document.getElementById('status').innerText = "å·²åœæ­¢";
                    document.getElementById('status').classList.remove("recording");
                    document.getElementById('btn').innerText = "é–‹å§‹ç›£è½";
                    document.getElementById('btn').style.background = "#4CAF50";
                }
            };

            recognition.onresult = (event) => {
                let interimTranscript = ''; // æš«å­˜ (é‚„æ²’è¬›å®Œçš„)
                let finalTranscript = '';   // ç¢ºå®š (è¬›å®Œçš„)

                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) {
                        // é€™ä¸€å¥è¬›å®Œäº†ï¼
                        finalTranscript += event.results[i][0].transcript;
                    } else {
                        // é€™ä¸€å¥é‚„åœ¨è¬›...
                        interimTranscript += event.results[i][0].transcript;
                    }
                }

                // æ›´æ–°ç•«é¢
                if (finalTranscript.length > 0) {
                    // 1. é¡¯ç¤ºç¶ è‰²å­—
                    finalSpan.innerText = finalTranscript;
                    // 2. æ¸…ç©ºç°è‰²å­—
                    interimSpan.innerText = "";
                    
                    console.log("é€å‡º:", finalTranscript);
                    
                    // 3. é€å‡ºçµ¦ Streamer.bot
                    if (ws && ws.readyState === WebSocket.OPEN) {
                        ws.send(JSON.stringify({
                            "request": "DoAction",
                            "action": { "name": actionName },
                            "args": { "dictationText": finalTranscript },
                            "id": "AI_" + Date.now()
                        }));
                    }
                }
                
                // é¡¯ç¤ºæ­£åœ¨è¬›çš„ç°è‰²å­—
                if (interimTranscript.length > 0) {
                    interimSpan.innerText = interimTranscript;
                }
            };
        }

        async function toggleRecognition() {
            if (isRecording) {
                isRecording = false;
                recognition.stop();
            } else {
                const audioSource = audioSelect.value;
                if (audioSource) {
                    try { await navigator.mediaDevices.getUserMedia({ audio: { deviceId: audioSource } }); } catch {}
                }
                recognition.start();
            }
        }
    </script>
</body>
</html>
