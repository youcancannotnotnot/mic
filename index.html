<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>AI ç›´æ’­è½å¯«æ©Ÿ (è‡ªå‹•é€£ç·šç‰ˆ)</title>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background: #222; color: #fff; text-align: center; padding: 50px; }
        #status { font-size: 24px; margin-bottom: 20px; color: #aaa; }
        #ws-status { font-size: 16px; margin-bottom: 30px; color: #ff5555; }
        #result { font-size: 32px; font-weight: bold; color: #0f0; margin: 20px; min-height: 50px; border: 1px dashed #444; padding: 20px; }
        button { padding: 15px 30px; font-size: 20px; cursor: pointer; border: none; border-radius: 5px; background: #4CAF50; color: white; }
        button:hover { background: #45a049; }
        button:disabled { background: #555; cursor: not-allowed; }
        .recording { color: #ff5555 !important; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.5; } }
        .connected { color: #4CAF50 !important; }
    </style>
</head>
<body>
    <h1>ğŸ™ï¸ AI ç›´æ’­è½å¯«æ©Ÿ</h1>
    <div id="ws-status">ğŸ”´ æ­£åœ¨é€£æ¥ Streamer.bot...</div>
    <div id="status">æº–å‚™å°±ç·’</div>
    <div id="result">...</div>
    <button onclick="toggleRecognition()" id="btn">é–‹å§‹ç›£è½</button>

    <script>
        // ================= è¨­å®šå€ =================
        const wsUrl = "ws://127.0.0.1:8080/";
        const actionName = "AI_Listener"; 
        // =========================================

        let recognition;
        let isRecording = false;
        let ws;

        // ä¸€é–‹å•Ÿç¶²é ç«‹åˆ»é€£ç·š
        window.onload = initWebSocket;

        function initWebSocket() {
            ws = new WebSocket(wsUrl);
            
            ws.onopen = () => { 
                console.log("WebSocket é€£ç·šæˆåŠŸ"); 
                document.getElementById('ws-status').innerText = "ğŸŸ¢ å·²é€£æ¥ Streamer.bot";
                document.getElementById('ws-status').classList.add("connected");
            };
            
            ws.onerror = (e) => { 
                document.getElementById('ws-status').innerText = "ğŸ”´ ç„¡æ³•é€£æ¥ (è«‹ç¢ºèª WebSocket Server æœ‰é–‹)";
            };

            ws.onclose = () => {
                document.getElementById('ws-status').innerText = "ğŸ”´ é€£ç·šä¸­æ–·ï¼Œ3ç§’å¾Œé‡é€£...";
                document.getElementById('ws-status').classList.remove("connected");
                setTimeout(initWebSocket, 3000); // æ–·ç·šè‡ªå‹•é‡é€£
            };
        }

        if ('webkitSpeechRecognition' in window) {
            recognition = new webkitSpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = false;
            recognition.lang = 'zh-TW';

            recognition.onstart = function() {
                isRecording = true;
                document.getElementById('status').innerText = "ğŸ¤ æ­£åœ¨è†è½ä¸­... (è«‹èªªè©±)";
                document.getElementById('status').classList.add("recording");
                document.getElementById('btn').innerText = "åœæ­¢";
                document.getElementById('btn').style.background = "#f44336";
            };

            recognition.onend = function() {
                if (isRecording) recognition.start();
            };

            recognition.onresult = function(event) {
                let finalTranscript = '';
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) {
                        finalTranscript += event.results[i][0].transcript;
                    }
                }

                if (finalTranscript.length > 0) {
                    document.getElementById('result').innerText = finalTranscript;
                    console.log("è¾¨è­˜çµæœ:", finalTranscript);
                    sendToStreamerBot(finalTranscript);
                }
            };
        } else {
            alert("æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´ï¼Œè«‹ç”¨ Chrome/Edgeï¼");
        }

        function toggleRecognition() {
            if (isRecording) {
                isRecording = false;
                recognition.stop();
                document.getElementById('status').innerText = "å·²åœæ­¢";
                document.getElementById('status').classList.remove("recording");
                document.getElementById('btn').innerText = "é–‹å§‹ç›£è½";
                document.getElementById('btn').style.background = "#4CAF50";
            } else {
                recognition.start();
            }
        }

        function sendToStreamerBot(text) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                const payload = {
                    "request": "DoAction",
                    "action": { "name": actionName },
                    "args": { "dictationText": text },
                    "id": "AI_Msg_" + Date.now() // åŠ å€‹ ID æ¯”è¼ƒä¿éšª
                };
                ws.send(JSON.stringify(payload));
                console.log("å·²å‚³é€è‡³ Streamer.bot");
            } else {
                document.getElementById('result').innerText += " (âš ï¸å‚³é€å¤±æ•—: æœªé€£ç·š)";
                console.error("å‚³é€å¤±æ•—ï¼ŒWebSocket æœªé€£ç·š");
            }
        }
    </script>
</body>
</html>